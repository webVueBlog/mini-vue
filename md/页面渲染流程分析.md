[页面渲染流程分析](https://juejin.cn/post/7085221720168087583#comment)

问：从输入URL到页面显示中间经历了什么？

答：嗯，整体流程经历，先知道浏览器的整体架构，有 渲染进程，插件进程，网络进程，浏览器主进程，GPU进程。

这5个进程各自负责如：

浏览器进程：主要负责 界面显示，用户交互，子进程管理，同时提供存储等功能

渲染进程：核心任务是 将HTML，CSS和JavaScript转换为用户可以与之交互的网页，排版引擎Blink和JavaScript引擎V8都是运行在该进程中，一般一个tab页对应一个渲染进程。

GPU进程：GPU的使用初衷是为了实现3D CSS的效果，随后网页，Chrome的UI界面都选择采用GPU来绘制，这使得GPU成为浏览器普遍的需求。最后，Chrome在其多进程架构上也引入了GPU进程。

网络进程：主要负责页面的网络资源加载。

插件进程：主要是负责插件的运行，因插件易崩溃，所以需要通过插件进程来隔离，以保证插件进程崩溃不会对浏览器和页面造成影响。

接着，我们进行流程分析，将用户输入一个url到页面渲染完成拆分几个阶段来看。

第一阶段：处理用户输入

主要是接收用户的信息输入，一般分两种情况：

1. 关键字搜索，例如查询 某某某， chrome会自动拼成完整的查询URL。例如：www.google.com/search?q=某某某
2. 输入网址: baidu.com

第二阶段：网络进程获取资源

该阶段主要获取渲染所需资源，一般入口是html文件，然后根据html文件的内容拉取其他类型资源。

开发涉及到：

- 缓存：浏览器缓存，服务端缓存等，从缓存中读取文件可大大降低渲染时间
- 根据域名查询 DNS 获取服务 IP 地址，建立TCP连接
- 可能存在的 3xx 重定向
- 不同的 Content-Type 触发不同的动作，例如
  - text/html html文件，触发渲染流程
  - application/octet-stream 触发下载流程

第三阶段：资源阶段处理

1. dom的解析：解析html文件内容，生成dom树结构
2. 样式计算：
   - 把css转换为浏览器能理解的结构：styleSheets(可通过document.styleSheets查看)
   - 属性值标准化, 例如 background: black => background: rgb(0,0,0)
   - 计算出 DOM 树中每个节点的具体样式（继承&层叠）
3. 布局阶段

通过dom的解析，样式计算等，我们得到了结构、样式相关的两棵树，接下来需要将二者结合，生成布局树

- 去除 DOM 中包含的不可见节点，如 head、link 和设置了 display:none 的节点
- 计算各个节点的具体布局位置

4. 分层

生成 Layout Tree 后并不会立刻开始渲染流程，考虑到页面会有一些复杂的 3D 效果、页面滚动和动画等，需要为某些节点生成单独的图层，并生成一棵对应的图层树 (LayerTree), 就像 PS 中的图层一样，正是这些图层叠加在一起构成了最终的页面图像。

在 Chrome 开发者工具 -> Layer 面板可查看当前页面的分层情况。





